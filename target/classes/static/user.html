<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th√¥ng tin t√†i kho·∫£n - Apex Sports</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .profile-container {
            max-width: 1000px;
            margin: 3rem auto;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 30px;
        }

        /* Sidebar Menu */
        .profile-sidebar {
            background: #1e1e1e;
            border: 1px solid #2a2a3e;
            border-radius: 12px;
            padding: 30px;
            height: fit-content;
            position: sticky;
            top: 100px;
        }

        .profile-avatar {
            text-align: center;
            margin-bottom: 25px;
        }

        .profile-avatar img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px solid var(--accent-green);
            margin-bottom: 15px;
        }

        .profile-avatar h3 {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .profile-avatar p {
            color: var(--text-gray);
            font-size: 0.9rem;
        }

        .profile-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .profile-menu li {
            margin-bottom: 10px;
        }

        .profile-menu a {
            display: block;
            padding: 12px 15px;
            border-radius: 6px;
            color: var(--text-light);
            transition: all 0.3s;
            font-weight: 500;
        }

        .profile-menu a:hover {
            background: #262626;
            color: var(--accent-green);
        }

        .profile-menu a.active {
            background: var(--accent-green);
            color: #000;
            font-weight: 700;
        }

        /* Main Content */
        .profile-content {
            background: #1e1e1e;
            border: 1px solid #2a2a3e;
            border-radius: 12px;
            padding: 40px;
        }

        .profile-section {
            display: none;
        }

        .profile-section.active {
            display: block;
        }

        .section-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text-light);
        }

        .section-subtitle {
            color: var(--text-gray);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            background: #262626;
            border: 1px solid #3a3a3a;
            border-radius: 6px;
            color: var(--text-light);
            font-size: 0.95rem;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-green);
            background: #2a2a2a;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .btn-save {
            background: var(--accent-green);
            color: #000;
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .btn-save:hover {
            background: #00cc52;
            box-shadow: 0 0 20px rgba(0, 255, 102, 0.3);
            transform: translateY(-2px);
        }

        .btn-cancel {
            background: transparent;
            color: var(--text-gray);
            padding: 12px 30px;
            border: 1px solid #3a3a3a;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            margin-left: 10px;
        }

        .btn-cancel:hover {
            border-color: var(--accent-green);
            color: var(--accent-green);
        }

        .alert {
            padding: 15px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .alert-success {
            background: rgba(0, 255, 102, 0.1);
            border: 1px solid var(--accent-green);
            color: var(--accent-green);
        }

        .alert-error {
            background: rgba(255, 59, 48, 0.1);
            border: 1px solid #ff3b30;
            color: #ff3b30;
        }

        .divider {
            height: 1px;
            background: #3a3a3a;
            margin: 30px 0;
        }

        @media (max-width: 768px) {
            .profile-container {
                grid-template-columns: 1fr;
            }

            .profile-sidebar {
                position: static;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container nav-container">
            <div style="display: flex; align-items: center;">
                <a href="index.html" class="logo">Apex<span>Sports</span></a>
                <ul class="nav-links" style="margin-left: 3rem;">
                    <li><a href="index.html">Trang ch·ªß</a></li>
                    <li><a href="category.html?type=men">Nam</a></li>
                    <li><a href="category.html?type=women">N·ªØ</a></li>
                    <li><a href="category.html?type=accessories">Ph·ª• ki·ªán</a></li>
                </ul>
            </div>

            <div class="nav-right">
                <div class="search-box">
                    <span class="search-icon-inside">üîç</span>
                    <input type="text" id="searchInput" placeholder="T√¨m s·∫£n ph·∫©m...">
                </div>
                
                <div class="auth-buttons">
                    <a href="login.html">ƒêƒÉng nh·∫≠p</a>
                    <span style="color: #444;">|</span>
                    <a href="register.html">ƒêƒÉng k√Ω</a>
                </div>

                <a href="cart.html" class="cart-icon">üõí <span class="cart-count">0</span></a>
            </div>
        </div>
    </nav>

    <main class="container">
        <div class="profile-container">
            <!-- Sidebar -->
            <aside class="profile-sidebar">
                <div class="profile-avatar">
                    <img id="sidebarAvatar" src="https://ui-avatars.com/api/?name=User&background=00ff66&color=000" alt="Avatar">
                    <h3 id="sidebarName">Ng∆∞·ªùi d√πng</h3>
                    <p id="sidebarEmail">email@example.com</p>
                </div>
                
                <ul class="profile-menu">
                    <li><a href="#" class="active" onclick="switchSection('info')">üìã Th√¥ng tin c√° nh√¢n</a></li>
                    <li><a href="#" onclick="switchSection('password')">üîí ƒê·ªïi m·∫≠t kh·∫©u</a></li>
                    <li><a href="cart.html">üõí Gi·ªè h√†ng</a></li>
                    <li><a href="index.html" onclick="logout()">üö™ ƒêƒÉng xu·∫•t</a></li>
                </ul>
            </aside>

            <!-- Main Content -->
            <div class="profile-content">
                <!-- Th√¥ng tin c√° nh√¢n -->
                <section id="infoSection" class="profile-section active">
                    <h2 class="section-title">Th√¥ng tin c√° nh√¢n</h2>
                    <p class="section-subtitle">Qu·∫£n l√Ω th√¥ng tin c√° nh√¢n c·ªßa b·∫°n</p>

                    <div id="infoAlert"></div>

                    <form id="profileForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="firstName">H·ªç *</label>
                                <input type="text" id="firstName" required>
                            </div>
                            <div class="form-group">
                                <label for="lastName">T√™n *</label>
                                <input type="text" id="lastName" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="email">Email *</label>
                            <input type="email" id="email" readonly style="background: #1a1a1a; cursor: not-allowed;">
                            <small style="color: var(--text-gray); font-size: 0.85rem; display: block; margin-top: 5px;">
                                Email kh√¥ng th·ªÉ thay ƒë·ªïi
                            </small>
                        </div>

                        <div class="form-group">
                            <label for="phone">S·ªë ƒëi·ªán tho·∫°i</label>
                            <input type="tel" id="phone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
                        </div>

                        <div class="form-group">
                            <label for="address">ƒê·ªãa ch·ªâ</label>
                            <textarea id="address" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ c·ªßa b·∫°n"></textarea>
                        </div>

                        <div class="divider"></div>

                        <div>
                            <button type="submit" class="btn-save">L∆∞u thay ƒë·ªïi</button>
                            <button type="button" class="btn-cancel" onclick="loadUserProfile()">H·ªßy</button>
                        </div>
                    </form>
                </section>

                <!-- ƒê·ªïi m·∫≠t kh·∫©u -->
                <section id="passwordSection" class="profile-section">
                    <h2 class="section-title">ƒê·ªïi m·∫≠t kh·∫©u</h2>
                    <p class="section-subtitle">C·∫≠p nh·∫≠t m·∫≠t kh·∫©u ƒë·ªÉ b·∫£o m·∫≠t t√†i kho·∫£n</p>

                    <div id="passwordAlert"></div>

                    <form id="passwordForm" style="max-width: 500px;">
                        <div class="form-group">
                            <label for="currentPassword">M·∫≠t kh·∫©u hi·ªán t·∫°i *</label>
                            <input type="password" id="currentPassword" required>
                        </div>

                        <div class="form-group">
                            <label for="newPassword">M·∫≠t kh·∫©u m·ªõi *</label>
                            <input type="password" id="newPassword" required minlength="6">
                            <small style="color: var(--text-gray); font-size: 0.85rem; display: block; margin-top: 5px;">
                                T·ªëi thi·ªÉu 6 k√Ω t·ª±
                            </small>
                        </div>

                        <div class="form-group">
                            <label for="confirmPassword">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi *</label>
                            <input type="password" id="confirmPassword" required minlength="6">
                        </div>

                        <div class="divider"></div>

                        <div>
                            <button type="submit" class="btn-save">ƒê·ªïi m·∫≠t kh·∫©u</button>
                            <button type="button" class="btn-cancel" onclick="document.getElementById('passwordForm').reset()">H·ªßy</button>
                        </div>
                    </form>
                </section>
            </div>
        </div>
    </main>

    <footer class="container" style="margin-top: 4rem; margin-bottom: 2rem; text-align: center; color: var(--text-gray); font-size: 0.9rem;">
        <p>&copy; 2026 Apex Sports. T·∫•t c·∫£ c√°c quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.</p>
    </footer>

    <script src="js/script.js"></script>
    <script>
        let currentUser = null;

        /**
         * Chuy·ªÉn section
         */
        function switchSection(section) {
            // Remove active class from all menu items
            document.querySelectorAll('.profile-menu a').forEach(a => a.classList.remove('active'));
            
            // Hide all sections
            document.querySelectorAll('.profile-section').forEach(s => s.classList.remove('active'));
            
            // Show selected section
            if (section === 'info') {
                document.getElementById('infoSection').classList.add('active');
                document.querySelector('.profile-menu a[onclick*="info"]').classList.add('active');
            } else if (section === 'password') {
                document.getElementById('passwordSection').classList.add('active');
                document.querySelector('.profile-menu a[onclick*="password"]').classList.add('active');
            }
        }

        /**
         * T·∫£i th√¥ng tin user
         */
        function loadUserProfile() {
            fetch('/api/user/profile', { credentials: 'include' })
                .then(res => {
                    if (res.status === 401) {
                        // Session h·∫øt h·∫°n - clear localStorage v√† redirect
                        localStorage.removeItem('user');
                        alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i');
                        window.location.href = 'login.html';
                        return;
                    }
                    return res.json();
                })
                .then(user => {
                    if (!user) return;
                    
                    currentUser = user;
                    
                    // Update localStorage with fresh data
                    localStorage.setItem('user', JSON.stringify(user));
                    
                    // Update sidebar
                    document.getElementById('sidebarAvatar').src = user.avatar || 'https://ui-avatars.com/api/?name=User&background=00ff66&color=000';
                    document.getElementById('sidebarName').textContent = `${user.firstName} ${user.lastName}`;
                    document.getElementById('sidebarEmail').textContent = user.email;
                    
                    // Update form
                    document.getElementById('firstName').value = user.firstName || '';
                    document.getElementById('lastName').value = user.lastName || '';
                    document.getElementById('email').value = user.email || '';
                    document.getElementById('phone').value = user.phone || '';
                    document.getElementById('address').value = user.address || '';
                })
                .catch(err => {
                    console.error('L·ªói t·∫£i th√¥ng tin:', err);
                    localStorage.removeItem('user');
                    alert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ng∆∞·ªùi d√πng');
                    window.location.href = 'login.html';
                });
        }

        /**
         * C·∫≠p nh·∫≠t th√¥ng tin
         */
        document.getElementById('profileForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const updates = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value
            };
            
            fetch('/api/user/profile', {
                method: 'PUT',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updates)
            })
            .then(res => res.json())
            .then(data => {
                const alertDiv = document.getElementById('infoAlert');
                if (data.success) {
                    alertDiv.innerHTML = '<div class="alert alert-success">‚úì ' + data.message + '</div>';
                    loadUserProfile(); // Reload data
                    updateUserNav(); // Update navbar
                } else {
                    alertDiv.innerHTML = '<div class="alert alert-error">‚ö† ' + data.message + '</div>';
                }
                
                // Auto hide alert
                setTimeout(() => alertDiv.innerHTML = '', 3000);
            })
            .catch(err => {
                console.error('L·ªói c·∫≠p nh·∫≠t:', err);
                document.getElementById('infoAlert').innerHTML = '<div class="alert alert-error">‚ö† Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t th√¥ng tin</div>';
            });
        });

        /**
         * ƒê·ªïi m·∫≠t kh·∫©u
         */
        document.getElementById('passwordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            const alertDiv = document.getElementById('passwordAlert');
            
            // Validate
            if (newPassword !== confirmPassword) {
                alertDiv.innerHTML = '<div class="alert alert-error">‚ö† M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp</div>';
                return;
            }
            
            if (newPassword.length < 6) {
                alertDiv.innerHTML = '<div class="alert alert-error">‚ö† M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±</div>';
                return;
            }
            
            fetch('/api/user/change-password', {
                method: 'PUT',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    currentPassword: currentPassword,
                    newPassword: newPassword
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alertDiv.innerHTML = '<div class="alert alert-success">‚úì ' + data.message + '</div>';
                    document.getElementById('passwordForm').reset();
                } else {
                    alertDiv.innerHTML = '<div class="alert alert-error">‚ö† ' + data.message + '</div>';
                }
                
                // Auto hide alert
                setTimeout(() => alertDiv.innerHTML = '', 3000);
            })
            .catch(err => {
                console.error('L·ªói ƒë·ªïi m·∫≠t kh·∫©u:', err);
                alertDiv.innerHTML = '<div class="alert alert-error">‚ö† Kh√¥ng th·ªÉ ƒë·ªïi m·∫≠t kh·∫©u</div>';
            });
        });

        /**
         * ƒêƒÉng xu·∫•t
         */
        function logout() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
                localStorage.removeItem('user');
                window.location.href = 'login.html';
            }
        }

        /**
         * Kh·ªüi t·∫°o
         */
        document.addEventListener('DOMContentLoaded', () => {
            // Ki·ªÉm tra session tr∆∞·ªõc khi load trang
            fetch('/api/auth/me', { credentials: 'include' })
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.user) {
                        // Session h·ª£p l·ªá - c·∫≠p nh·∫≠t localStorage
                        localStorage.setItem('user', JSON.stringify(data.user));
                        updateUserNav(); // Update navbar
                        loadUserProfile(); // Load user data
                    } else {
                        // Session kh√¥ng h·ª£p l·ªá - redirect to login
                        localStorage.removeItem('user');
                        alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i');
                        window.location.href = 'login.html';
                    }
                })
                .catch(err => {
                    console.error('L·ªói ki·ªÉm tra session:', err);
                    localStorage.removeItem('user');
                    window.location.href = 'login.html';
                });
            
            // Update cart count
            fetch(CART_API_URL + '/count', { credentials: 'include' })
                .then(res => res.json())
                .then(count => {
                    const cartCount = document.querySelector('.cart-count');
                    if (cartCount) cartCount.textContent = count;
                });
        });
    </script>
</body>
</html>
